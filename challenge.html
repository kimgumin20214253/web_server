<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì €ì¶• ì•± - ì±Œë¦°ì§€</title>
    <style>
        /* [ê¸°ë³¸ ìŠ¤íƒ€ì¼ ìœ ì§€] */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'Pretendard', sans-serif; background-color: #FAF4EC; color: #333; overflow: hidden; display: flex; flex-direction: column; }
        .header { padding: 40px 20px 20px; text-align: center; font-size: 24px; font-weight: bold; }
        .content-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        .section-title { font-size: 16px; color: #555; margin-bottom: 5px; font-weight: bold; }
        
        #challenge-list-container { display: flex; flex-direction: column; gap: 20px; }
        
        .challenge-card { background-color: #FFEBEB; border-radius: 20px; padding: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; position: relative; }
        .card-cat { font-size: 14px; color: #888; margin-bottom: 5px; }
        .card-title { font-size: 22px; font-weight: 800; margin-bottom: 5px; line-height: 1.3; }
        .card-date { font-size: 13px; color: #666; margin-bottom: 15px; }
        .d-day-red { color: #FF6B6B; font-weight: bold; }
        .progress-wrapper { width: 100%; background-color: #FFF; border-radius: 10px; height: 10px; margin-bottom: 5px; overflow: hidden; }
        .progress-bar { height: 100%; background-color: #FFD54F; width: 0%; transition: width 0.5s ease; border-radius: 10px; }
        .progress-text { text-align: right; font-size: 12px; color: #666; margin-bottom: 20px; }
        .card-btns { display: flex; gap: 10px; }
        .card-btn { flex: 1; padding: 12px; border: none; border-radius: 30px; font-weight: bold; font-size: 13px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 5px; }
        .btn-add-money { background-color: #FFD54F; color: #333; }
        .btn-give-up { background-color: #FFCA28; color: #333; opacity: 0.8; }

        .add-challenge-box { background-color: #FFE082; border-radius: 20px; min-height: 100px; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.05); font-size: 18px; font-weight: bold; gap: 10px; margin-top: 10px; }
        .history-btn { width: 100%; padding: 15px; background-color: #FFCC80; border: none; border-radius: 30px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px; }

        .navbar { height: 110px; background-color: transparent; border-top: 4px solid #D9D9D9; display: flex; justify-content: space-evenly; align-items: center; padding-bottom: 10px; z-index: 50; flex-shrink: 0; }
        .nav-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; border: none; background: none; gap: 6px; text-decoration: none; }
        .nav-icon-box { width: 58px; height: 58px; background-color: #FFD54F; border-radius: 14px; display: flex; justify-content: center; align-items: center; box-shadow: 0 3px 6px rgba(0,0,0,0.1); transition: all 0.3s ease; }
        .nav-icon-img { width: 32px; height: 32px; object-fit: contain; }
        .nav-text { font-size: 12px; color: #888; font-weight: 500; }
        .nav-item.active .nav-icon-box { background-color: #FF6B6B; transform: translateY(-5px); box-shadow: 0 5px 10px rgba(255, 107, 107, 0.3); }
        .nav-item.active .nav-icon-img { filter: brightness(0) invert(1); }
        .nav-item.active .nav-text { color: #333; font-weight: bold; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .modal-overlay.open { display: flex; }
        .modal-content { background-color: #FFF; width: 90%; max-width: 360px; border-radius: 20px; padding: 25px; box-sizing: border-box; position: relative; max-height: 85%; overflow-y: auto; }
        .modal-title { font-size: 20px; font-weight: bold; text-align: center; margin-bottom: 20px; }
        .close-btn { position: absolute; top: 20px; left: 20px; font-size: 20px; cursor: pointer; font-weight: bold; }

        .step-block { display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px dashed #DDD; }
        .step-block:last-of-type { border-bottom: none; margin-bottom: 0; }
        .step-label { font-size: 16px; font-weight: bold; color: #555; }
        .category-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .cat-item { background-color: #F8F8F8; border-radius: 15px; padding: 15px; cursor: pointer; border: 2px solid transparent; display: flex; flex-direction: column; align-items: center; }
        .cat-item.selected { border-color: #FF6B6B; background-color: #FFF0F0; }
        .cat-img { width: 40px; height: 40px; object-fit: contain; margin-bottom: 5px; }
        .chip-container { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .chip { padding: 8px 15px; background-color: #FFE082; border-radius: 20px; font-size: 14px; cursor: pointer; border: 2px solid transparent; }
        .chip.selected { border-color: #FF6B6B; background-color: #FFD54F; font-weight: bold; }
        .money-options { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .money-chip { padding: 10px 20px; background-color: #EFEBE6; border-radius: 20px; cursor: pointer; border: 2px solid transparent; }
        .money-chip.selected { border-color: #FF6B6B; background-color: #FFD54F; font-weight: bold; }
        .input-box { width: 100%; padding: 15px; background-color: #EFEBE6; border: none; border-radius: 10px; font-size: 16px; text-align: center; font-weight: bold; box-sizing: border-box; }
        .date-picker-container { display: flex; gap: 10px; justify-content: center; align-items: center; margin-bottom: 10px; }
        .date-input { padding: 10px; border-radius: 10px; border: 1px solid #ddd; background: #EFEBE6; width: 130px;}
        .date-result { text-align: center; color: #FF6B6B; font-weight: bold; font-size: 18px; margin-bottom: 20px; }
        .confirm-btn { width: 100%; padding: 15px; background-color: #FFD54F; border: none; border-radius: 30px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; }

        .history-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 15px; }
        .history-card { padding: 20px; border-radius: 15px; border: 3px solid #DDD; background-color: #FFF; position: relative; }
        .history-card.ongoing { border-color: #FFD54F; background-color: #FFF9E6; }
        .history-card.fail { border-color: #FF6B6B; background-color: #FFF0F0; }
        .history-card.success { border-color: #4D96FF; background-color: #E1F5FE; }
        .h-tag { font-size: 12px; color: #666; margin-bottom: 5px; }
        .h-title { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        .h-date { font-size: 12px; color: #888; margin-bottom: 10px; }
        .h-status-badge { position: absolute; bottom: 20px; right: 20px; padding: 8px 15px; border-radius: 5px; font-weight: bold; font-size: 12px; }
        .ongoing .h-status-badge { background-color: #FFD54F; }
        .fail .h-status-badge { background-color: #FF6B6B; color: white; }
        .success .h-status-badge { background-color: #4D96FF; color: white; }
        .h-progress-bar { width: 100%; height: 8px; background: #EEE; border-radius: 5px; overflow: hidden; }
        .h-fill { height: 100%; border-radius: 5px; }
        .ongoing .h-fill { background-color: #FFD54F; }
        .fail .h-fill { background-color: #FF6B6B; }
        .success .h-fill { background-color: #4D96FF; }
        .h-total-saved { margin-top: 10px; font-weight: bold; color: #4D96FF; font-size: 14px; }

        /* [ì¶”ê°€ë¨]: ë§ˆì´ë„ˆìŠ¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .chip.negative {
            background-color: #FFCDD2; /* ì—°í•œ ë¹¨ê°• */
            color: #B71C1C; /* ì§„í•œ ë¹¨ê°• */
            border-color: #FF6B6B;
        }

    </style>
</head>
<body>

    <div class="header">ì±Œë¦°ì§€</div>

    <div class="content-container">
        <div class="section-title">ì§„í–‰ì¤‘ì¸ ì±Œë¦°ì§€</div>
        <div id="challenge-list-container"></div>
        <div id="add-challenge-box" class="add-challenge-box" onclick="openAddChallengeModal()"><span>+</span> ì±Œë¦°ì§€ ì¶”ê°€</div>
        <button class="history-btn" onclick="openHistoryModal()">ì§€ê¸ˆê¹Œì§€ í•œ ì±Œë¦°ì§€ ëª©ë¡</button>
    </div>

    <div class="navbar">
        <a href="home.html" class="nav-item">
            <div class="nav-icon-box"><img src="icon_home.png" class="nav-icon-img"></div>
            <span class="nav-text">í™ˆ</span>
        </a>
        <a href="stat.html" class="nav-item">
            <div class="nav-icon-box"><img src="icon_stat.png" class="nav-icon-img"></div>
            <span class="nav-text">í†µê³„</span>
        </a>
        <div class="nav-item active">
            <div class="nav-icon-box"><img src="icon_challenge.png" class="nav-icon-img"></div>
            <span class="nav-text">ì±Œë¦°ì§€</span>
        </div>
        <a href="user.html" class="nav-item">
            <div class="nav-icon-box"><img src="icon_user.png" class="nav-icon-img"></div>
            <span class="nav-text">ë‚˜ì˜ ì •ë³´</span>
        </a>
    </div>

    <div id="add-money-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="close-btn" onclick="closeModal('add-money-modal')">â†</div>
            <div class="modal-title">ì ˆì•½ ê¸ˆì•¡ ì¶”ê°€í•˜ê¸°</div>
            <input type="number" id="money-input" class="input-box" placeholder="0" style="font-size:32px; margin-bottom:10px;">
            <div style="text-align:center; color:#888; margin-bottom:20px; font-size:12px;">(í˜„ì¬ ëˆ„ì  ì ˆì•½ ê¸ˆì•¡: <span id="modal-current-saved">0</span>ì›)</div>
            
            <div class="money-options" style="justify-content:center; margin-bottom:10px;">
                <button class="chip" onclick="addInputMoney(100)">+100</button>
                <button class="chip" onclick="addInputMoney(500)">+500</button>
                <button class="chip" onclick="addInputMoney(1000)">+1,000</button>
                <button class="chip" onclick="addInputMoney(10000)">+1ë§Œ</button>
            </div>
            <div class="money-options" style="justify-content:center; margin-bottom:20px;">
                <button class="chip negative" onclick="addInputMoney(-100)">-100</button>
                <button class="chip negative" onclick="addInputMoney(-500)">-500</button>
                <button class="chip negative" onclick="addInputMoney(-1000)">-1,000</button>
                <button class="chip negative" onclick="addInputMoney(-10000)">-1ë§Œ</button>
            </div>
            <button class="confirm-btn" onclick="confirmAddMoney()">ì™„ë£Œ</button>
        </div>
    </div>

    <div id="add-challenge-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="close-btn" onclick="closeModal('add-challenge-modal')">â†</div>
            <div class="modal-title">ì±Œë¦°ì§€ ì¶”ê°€</div>
            <div class="step-block">
                <div class="step-label">Step 1. ì¹´í…Œê³ ë¦¬ ì„ íƒ</div>
                <div class="category-grid">
                    <div class="cat-item" onclick="selectCategory('meal', this)"><img src="cat_meal.png" class="cat-img"><span>ì‹ì‚¬</span></div>
                    <div class="cat-item" onclick="selectCategory('transport', this)"><img src="cat_transport.png" class="cat-img"><span>êµí†µ</span></div>
                    <div class="cat-item" onclick="selectCategory('shopping', this)"><img src="cat_shopping.png" class="cat-img"><span>ì‡¼í•‘</span></div>
                    <div class="cat-item" onclick="selectCategory('leisure', this)"><img src="cat_leisure.png" class="cat-img"><span>ì—¬ê°€</span></div>
                </div>
            </div>
            <div class="step-block">
                <div class="step-label">Step 2. ì„¸ë¶€ ë‚´ìš© ì„ íƒ</div>
                <div id="chip-area" class="chip-container"><span style="color:#aaa; font-size:14px;">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</span></div>
            </div>
            <div class="step-block">
                <div class="step-label">Step 3. ì§€ì¶œ í•­ëª© ê¸ˆì•¡ ì„ íƒ</div>
                <div class="money-options">
                    <div class="money-chip" onclick="selectTargetAmount(0, this)">0ì›</div>
                    <div class="money-chip" onclick="selectTargetAmount(5000, this)">5,000ì›</div>
                    <div class="money-chip" onclick="selectTargetAmount(10000, this)">10,000ì›</div>
                    <div class="money-chip" onclick="selectTargetAmount(30000, this)">30,000ì›</div>
                </div>
                <div style="margin-top:10px; font-weight:bold; color:#888;">ì§ì ‘ ì…ë ¥</div>
                <input type="number" id="custom-target-amount" class="input-box" placeholder="ì§ì ‘ ì…ë ¥" oninput="selectTargetAmount(this.value, null)">
            </div>
            <div class="step-block">
                <div class="step-label">Step 4. ê¸°ê°„ ì„ íƒ</div>
                <div class="date-picker-container">
                    <input type="date" id="start-date" class="date-input" onchange="calcDuration()">
                    <span>~</span>
                    <input type="date" id="end-date" class="date-input" onchange="calcDuration()">
                </div>
                <div class="date-result" id="duration-result"></div>
            </div>
            <div class="step-block">
                <div class="step-label">Step 5. ì±Œë¦°ì§€ ì´ë¦„ ì„¤ì •</div>
                <input type="text" id="challenge-name-input" class="input-box" placeholder="ì˜ˆ: 3ì¼ê°„ ì»¤í”¼ ëŠê¸°">
            </div>
            <button class="confirm-btn" onclick="createChallenge()">ì±Œë¦°ì§€ ìƒì„± ì™„ë£Œ</button>
        </div>
    </div>

    <div id="history-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="close-btn" onclick="closeModal('history-modal')">â†</div>
            <div class="modal-title">ì—­ëŒ€ ì±Œë¦°ì§€ ëª©ë¡</div>
            <ul id="history-list" class="history-list"></ul>
            <button id="history-more-btn" class="confirm-btn" style="background:#EEE; font-size:14px; margin-top:10px;" onclick="showMoreHistory()">â¬‡ ë” ë³´ê¸°</button>
        </div>
    </div>

    <script>
        let challenges = []; 
        let newChallenge = {};
        let selectedChallengeId = null;
        let currentUser = null;

        const subCategories = {
            'meal': ['ë°°ë‹¬ìŒì‹', 'í•™ì‹', 'í¸ì˜ì ', 'ë§ˆíŠ¸', 'ë ˆìŠ¤í† ë‘', 'ê¸¸ê±°ë¦¬', 'íšŒì‹'],
            'transport': ['ë²„ìŠ¤', 'ì§€í•˜ì² ', 'íƒì‹œ', 'ê¸°ì°¨', 'í‚¥ë³´ë“œ', 'ìê°€ìš©', 'ì¹´í’€'],
            'shopping': ['ë°±í™”ì ', 'ì˜ë¥˜ê°€ê²Œ', 'ê¸°ë…í’ˆ', 'í™”ì¥í’ˆ', 'ë‹¤ì´ì†Œ', 'ë¬¸êµ¬ì ', 'ì „ìì œí’ˆ'],
            'leisure': ['ë¯¸ìˆ ', 'ìŒì•…', 'ìŠ¤í¬ì¸ ', 'ë¬¸í•™', 'íœ´ì‹', 'ì—¬í–‰', 'ê²Œì„']
        };

        window.onload = function() {
            // ë¡œê·¸ì¸ í™•ì¸
            const savedUser = localStorage.getItem('loginUser');
            if(!savedUser) { alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); location.href='login.html'; return; }
            currentUser = JSON.parse(savedUser);

            // ë°ì´í„° ë¡œë“œ
            loadServerData();
        };

        // [í•µì‹¬] ì„œë²„ì—ì„œ ì±Œë¦°ì§€ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        function loadServerData() {
            // Render ë°°í¬ í™˜ê²½ì—ì„œëŠ” ìƒëŒ€ ê²½ë¡œ ì‚¬ìš© ê¶Œì¥
            fetch(`/api/challenges/${currentUser.id}`)
            .then(res => res.json())
            .then(data => {
                challenges = data; // DB ì»¬ëŸ¼ëª…(snake_case) ê·¸ëŒ€ë¡œ ì‚¬ìš©
                checkChallengeStatus();
                renderMain();
            })
            .catch(err => console.error(err));
        }

        // [í•µì‹¬] ì±Œë¦°ì§€ ì„±ê³µ ì—¬ë¶€ ì²´í¬ (ì„±ê³µì‹œ DB ì—…ë°ì´íŠ¸)
        function checkChallengeStatus() {
            const today = new Date(); today.setHours(0,0,0,0);
            
            challenges.forEach(c => {
                if(c.status === 'ongoing') {
                    // DB Date -> JS Date ë³€í™˜
                    const end = new Date(c.end_date);
                    if(today > end) {
                        // 1. ì±Œë¦°ì§€ ìƒíƒœ 'success'ë¡œ ì—…ë°ì´íŠ¸
                        // saved_amountëŠ” ê·¸ëŒ€ë¡œ ì‚¬ìš©
                        updateChallengeStatus(c.id, c.saved_amount, 'success');

                        // 2. ì €ê¸ˆ ë‚´ì—­ì— ë³´ìƒ ì¶”ê°€ (DB ì—°ë™)
                        // (ëˆ„ì ì•¡ ê³„ì‚°ì„ ìœ„í•´ ë¨¼ì € ì €ê¸ˆë‚´ì—­ ì¡°íšŒ)
                        fetch(`/api/savings/${currentUser.id}`)
                        .then(res => res.json())
                        .then(history => {
                            // í˜„ì¬ ì´ì•¡ ê³„ì‚°
                            // DB ë°ì´í„° êµ¬ì¡°ì— 'balance' í•„ë“œê°€ ìˆë‹¤ë©´ ê·¸ê²ƒì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ìœ¼ë‚˜, 
                            // í˜„ì¬ëŠ” savings í…Œì´ë¸”ì˜ ëª¨ë“  amountë¥¼ í•©ì‚°í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í•¨.
                            let currentTotal = history.reduce((acc, cur) => acc + cur.amount, 0);
                            let newBalance = currentTotal + c.saved_amount;
                            const todayStr = new Date().toISOString().split('T')[0];

                            // ì €ê¸ˆ API í˜¸ì¶œ
                            fetch('/api/save', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({
                                    userId: currentUser.id,
                                    category: c.category,
                                    subCategory: `[ì±Œë¦°ì§€ ì„±ê³µ] ${c.title}`,
                                    amount: c.saved_amount,
                                    memo: 'ì±Œë¦°ì§€ ë‹¬ì„± ë³´ìƒ',
                                    balance: newBalance,
                                    dateStr: todayStr
                                })
                            });
                            alert(`ğŸ‰ ì±Œë¦°ì§€ ì„±ê³µ! ${c.title}\nëª¨ì€ ê¸ˆì•¡ì´ ì €ê¸ˆí†µì— ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                        });
                    }
                }
            });
        }

        // ì±Œë¦°ì§€ ìƒíƒœ ì—…ë°ì´íŠ¸ API í˜¸ì¶œ
        function updateChallengeStatus(id, savedAmount, status) {
            fetch('/api/challenge/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id, savedAmount, status })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) loadServerData(); // ìƒˆë¡œê³ ì¹¨
            });
        }

        // === í™”ë©´ ë Œë”ë§ ===
        function renderMain() {
            const listContainer = document.getElementById('challenge-list-container');
            listContainer.innerHTML = "";

            // DBì—ì„œ ë°›ì€ ë°ì´í„°ëŠ” ì´ë¯¸ ìµœì‹ ìˆœì´ ì•„ë‹ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì •ë ¬í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
            const ongoingList = challenges.filter(c => c.status === 'ongoing')
                                            .sort((a, b) => new Date(a.start_date) - new Date(b.start_date)); // ì‹œì‘ì¼ ìˆœìœ¼ë¡œ ì •ë ¬

            if(ongoingList.length === 0) {
                listContainer.innerHTML = "<div style='text-align:center; color:#aaa; padding:20px;'>ì§„í–‰ ì¤‘ì¸ ì±Œë¦°ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
            }

            ongoingList.forEach(c => {
                // DB ì»¬ëŸ¼ëª… ì‚¬ìš© (c.start_date ë“±)
                const startStr = c.start_date.split('T')[0];
                const endStr = c.end_date.split('T')[0];

                // D-Day
                const today = new Date(); today.setHours(0,0,0,0);
                const end = new Date(endStr);
                const diff = Math.ceil((end - today) / (1000 * 60 * 60 * 24));
                const dDayText = (diff < 0) ? "ì¢…ë£Œ" : `D-${diff}`;

                // Progress (ë‚ ì§œ)
                const start = new Date(startStr);
                const totalDays = (end - start) / (1000 * 60 * 60 * 24) + 1;
                const passed = (today - start) / (1000 * 60 * 60 * 24) + 1;
                let pct = Math.floor((passed/totalDays)*100);
                if(pct>100) pct=100; if(pct<0) pct=0;

                const html = `
                    <div class="challenge-card">
                        <div class="card-cat">[${c.category}] - ${c.sub_category}</div>
                        <div class="card-title">${c.title}</div>
                        <div class="card-date"><span>${startStr} ~ ${endStr}</span> <span class="d-day-red">${dDayText}</span></div>
                        <div class="progress-wrapper"><div class="progress-bar" style="width:${pct}%"></div></div>
                        <div class="progress-text">${Math.min(passed, totalDays)} / ${totalDays}ì¼</div>
                        <div class="card-btns">
                            <button class="card-btn btn-add-money" onclick="openAddMoneyModal(${c.id}, ${c.saved_amount})">
                                ğŸ’° ì ˆì•½ ê¸ˆì•¡ ì¶”ê°€<br><span style="font-size:10px; font-weight:normal;">(ëˆ„ì  ${c.saved_amount.toLocaleString()}ì›)</span>
                            </button>
                            <button class="card-btn btn-give-up" onclick="giveUpChallenge(${c.id})">âŒ í¬ê¸°í•˜ê¸°</button>
                        </div>
                    </div>`;
                listContainer.innerHTML += html;
            });
        }

        // === ê¸°ëŠ¥ í•¨ìˆ˜ë“¤ ===
        function openAddMoneyModal(id, currentSaved) {
            selectedChallengeId = id;
            document.getElementById('money-input').value = "";
            document.getElementById('modal-current-saved').innerText = currentSaved.toLocaleString();
            document.getElementById('add-money-modal').classList.add('open');
        }
        
        // [ìˆ˜ì •ë¨]: addInputMoney í•¨ìˆ˜ (ìŒìˆ˜ ì²˜ë¦¬ í¬í•¨)
        function addInputMoney(amt) {
            const el = document.getElementById('money-input');
            let currentVal = parseInt(el.value)||0;
            currentVal += amt;
            if (currentVal < 0) currentVal = 0; // ê¸ˆì•¡ì´ ìŒìˆ˜ê°€ ë˜ì§€ ì•Šë„ë¡ ë°©ì§€
            el.value = currentVal;
        }

        function confirmAddMoney() {
            const amt = parseInt(document.getElementById('money-input').value);
            if(!amt || amt <= 0) return;
            
            const target = challenges.find(c => c.id === selectedChallengeId);
            if(target) {
                const newSaved = target.saved_amount + amt;
                updateChallengeStatus(target.id, newSaved, 'ongoing'); // savedAmount ì—…ë°ì´íŠ¸ë§Œ í•„ìš”
                closeModal('add-money-modal');
                alert("ê¸ˆì•¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");
            }
        }

        function giveUpChallenge(id) {
            if(!confirm("ì •ë§ í¬ê¸°í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì‹¤íŒ¨ë¡œ ê¸°ë¡ë©ë‹ˆë‹¤)")) return;
            const target = challenges.find(c => c.id === id);
            if(target) {
                // saved_amountëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ê³  statusë§Œ 'fail'ë¡œ ì—…ë°ì´íŠ¸
                updateChallengeStatus(id, target.saved_amount, 'fail'); 
                alert("ì±Œë¦°ì§€ë¥¼ í¬ê¸°í–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // ì±Œë¦°ì§€ ìƒì„± (ì„œë²„ ì „ì†¡)
        function createChallenge() {
            const title = document.getElementById('challenge-name-input').value;
            if(!newChallenge.cat || !newChallenge.sub || newChallenge.targetAmt===undefined || !newChallenge.startStr || !title) {
                alert("ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return;
            }

            fetch('/api/challenge', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    userId: currentUser.id,
                    title: title,
                    category: newChallenge.cat,
                    subCategory: newChallenge.sub,
                    targetAmount: newChallenge.targetAmt,
                    startDate: newChallenge.startStr,
                    endDate: newChallenge.endStr
                })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    alert("ì±Œë¦°ì§€ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    loadServerData();
                    closeModal('add-challenge-modal');
                } else alert("ìƒì„± ì‹¤íŒ¨");
            });
        }

        // ì—­ëŒ€ ëª©ë¡ (DB ë°ì´í„°)
        let historyLimit = 3;
        function openHistoryModal() { historyLimit = 3; renderHistory(); document.getElementById('history-modal').classList.add('open'); }
        function renderHistory() {
            const list = document.getElementById('history-list'); list.innerHTML = "";
            // ì§„í–‰ ì¤‘ì´ ì•„ë‹Œ ëª©ë¡ë§Œ ê°€ì ¸ì™€ì„œ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
            const historyList = challenges.filter(c => c.status !== 'ongoing')
                                            .sort((a, b) => new Date(b.start_date) - new Date(a.start_date)); 
            
            const viewList = historyList.slice(0, historyLimit); 
            
            viewList.forEach(c => {
                const li = document.createElement('li');
                li.className = `history-card ${c.status}`;
                let statusText = (c.status==='fail')?"ì‹¤íŒ¨":(c.status==='success')?"ì„±ê³µ":"ì§„í–‰ ì¤‘";
                let moneyHtml = (c.status==='success') ? `<div class="h-total-saved">+${c.saved_amount.toLocaleString()}ì›</div>` : "";
                
                // ë‚ ì§œ í¬ë§·
                const startStr = c.start_date.split('T')[0];
                const endStr = c.end_date.split('T')[0];
                
                // ê²Œì´ì§€ ê³„ì‚° (ìƒëµ - ìœ„ì™€ ë™ì¼ ë¡œì§)
                // ... (ê°„ë‹¨íˆ 100% or ì§„í–‰ë¥  í‘œì‹œ)
                
                li.innerHTML = `
                    <div class="h-tag">[${c.category}] - ${c.sub_category}</div>
                    <div class="h-title">${c.title}</div>
                    <div class="h-date">(${startStr} ~ ${endStr})</div>
                    ${moneyHtml}
                    <div class="h-status-badge">${statusText}</div>
                `;
                list.appendChild(li);
            });
            if(historyList.length > historyLimit) document.getElementById('history-more-btn').style.display='block';
            else document.getElementById('history-more-btn').style.display='none';
        }
        function showMoreHistory() { historyLimit += 3; renderHistory(); }

        // UI ìœ í‹¸ í•¨ìˆ˜ë“¤ (ê¸°ì¡´ê³¼ ë™ì¼)
        function openAddChallengeModal() {
            newChallenge = { saved: 0 };
            document.querySelectorAll('.cat-item').forEach(el=>el.classList.remove('selected'));
            document.getElementById('chip-area').innerHTML = '<span style="color:#aaa;">ì¹´í…Œê³ ë¦¬ ì„ íƒ í•„ìš”</span>';
            document.getElementById('custom-target-amount').value = "";
            document.getElementById('challenge-name-input').value = "";
            const today = new Date(); const next = new Date(); next.setDate(today.getDate()+7);
            document.getElementById('start-date').valueAsDate = today;
            document.getElementById('end-date').valueAsDate = next;
            calcDuration();
            document.getElementById('add-challenge-modal').classList.add('open');
        }
        function selectCategory(cat, el) {
            newChallenge.cat = cat;
            document.querySelectorAll('.cat-item').forEach(e=>e.classList.remove('selected')); el.classList.add('selected');
            const area = document.getElementById('chip-area'); area.innerHTML = "";
            subCategories[cat].forEach(sub => {
                const chip = document.createElement('div'); chip.className = 'chip'; chip.innerText = sub;
                chip.onclick = () => { newChallenge.sub = sub; document.querySelectorAll('.chip').forEach(c=>c.classList.remove('selected')); chip.classList.add('selected'); };
                area.appendChild(chip);
            });
            const direct = document.createElement('div'); direct.className = 'chip'; direct.innerText = "ì§ì ‘ ì…ë ¥";
            direct.onclick = () => { const t = prompt("ì…ë ¥"); if(t){ newChallenge.sub=t; document.querySelectorAll('.chip').forEach(c=>c.classList.remove('selected')); direct.classList.add('selected'); }};
            area.appendChild(direct);
        }
        function selectTargetAmount(amt, el) {
            newChallenge.targetAmt = parseInt(amt);
            if(el) { document.querySelectorAll('.money-chip').forEach(c=>c.classList.remove('selected')); el.classList.add('selected'); document.getElementById('custom-target-amount').value=""; }
        }
        function calcDuration() {
            const s = new Date(document.getElementById('start-date').value);
            const e = new Date(document.getElementById('end-date').value);
            if(s && e && e >= s) {
                const diff = (e - s)/(1000*60*60*24)+1;
                document.getElementById('duration-result').innerText = `${Math.ceil(diff)}ì¼ê°„`;
                newChallenge.startStr = document.getElementById('start-date').value;
                newChallenge.endStr = document.getElementById('end-date').value;
            } else document.getElementById('duration-result').innerText = "ë‚ ì§œ í™•ì¸";
        }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
    </script>
</body>
</html>