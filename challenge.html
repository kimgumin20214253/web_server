<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì €ì¶• ì•± - ì±Œë¦°ì§€</title>
    <style>
        /* [ê¸°ë³¸ ìŠ¤íƒ€ì¼ ìœ ì§€] */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'Pretendard', sans-serif; background-color: #FAF4EC; color: #333; overflow: hidden; display: flex; flex-direction: column; }
        .header { padding: 40px 20px 20px; text-align: center; font-size: 24px; font-weight: bold; }
        .content-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        .section-title { font-size: 16px; color: #555; margin-bottom: 5px; font-weight: bold; }
        
        #challenge-list-container { display: flex; flex-direction: column; gap: 20px; }
        
        /* ì±Œë¦°ì§€ ì¹´ë“œ ë””ìì¸ */
        .challenge-card { background-color: #FFEBEB; border-radius: 20px; padding: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; position: relative; }
        
        /* ì¹´í…Œê³ ë¦¬ í°íŠ¸ ìˆ˜ì •ë¨ */
        .card-cat { font-size: 16px; font-weight: bold; color: #666; margin-bottom: 8px; }
        .card-title { font-size: 22px; font-weight: 800; margin-bottom: 5px; line-height: 1.3; }
        
        /* ë‚ ì§œ í°íŠ¸ ìˆ˜ì •ë¨ */
        .card-date { font-size: 14px; font-weight: bold; color: #555; margin-bottom: 15px; }
        .d-day-red { color: #FF6B6B; font-weight: 900; font-size: 15px; margin-left: 5px; }
        
        /* ê²Œì´ì§€ë°” ë ˆì´ì•„ì›ƒ ìˆ˜ì •ë¨ */
        .progress-container {
            display: flex;
            align-items: center; 
            gap: 10px; 
            margin-bottom: 20px;
        }
        .progress-wrapper { flex: 1; background-color: #FFF; border-radius: 10px; height: 10px; overflow: hidden; }
        .progress-bar { height: 100%; background-color: #FFD54F; width: 0%; transition: width 0.5s ease; border-radius: 10px; }
        
        .progress-text { 
            font-size: 13px; 
            font-weight: bold; 
            color: #666; 
            white-space: nowrap; 
        }

        .card-btns { display: flex; gap: 10px; }
        .card-btn { flex: 1; padding: 12px; border: none; border-radius: 30px; font-weight: bold; font-size: 13px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 5px; }
        .btn-add-money { background-color: #FFD54F; color: #333; }
        .btn-give-up { background-color: #FFCA28; color: #333; opacity: 0.8; }

        .add-challenge-box { background-color: #FFE082; border-radius: 20px; min-height: 100px; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.05); font-size: 18px; font-weight: bold; gap: 10px; margin-top: 10px; }
        .history-btn { width: 100%; padding: 15px; background-color: #FFCC80; border: none; border-radius: 30px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px; }

        /* ë„¤ë¹„ê²Œì´ì…˜ ë°” */
        .navbar { height: 110px; background-color: transparent; border-top: 4px solid #D9D9D9; display: flex; justify-content: space-evenly; align-items: center; padding-bottom: 10px; z-index: 50; flex-shrink: 0; }
        .nav-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; border: none; background: none; gap: 6px; text-decoration: none; }
        .nav-icon-box { width: 58px; height: 58px; background-color: #FFD54F; border-radius: 14px; display: flex; justify-content: center; align-items: center; box-shadow: 0 3px 6px rgba(0,0,0,0.1); transition: all 0.3s ease; }
        .nav-icon-img { width: 32px; height: 32px; object-fit: contain; }
        .nav-text { font-size: 12px; color: #888; font-weight: 500; }
        .nav-item.active .nav-icon-box { background-color: #FF6B6B; transform: translateY(-5px); box-shadow: 0 5px 10px rgba(255, 107, 107, 0.3); }
        .nav-item.active .nav-icon-img { filter: brightness(0) invert(1); }
        .nav-item.active .nav-text { color: #333; font-weight: bold; }

        /* ëª¨ë‹¬ ê³µí†µ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .modal-overlay.open { display: flex; }
        .modal-content { background-color: #FFF; width: 90%; max-width: 360px; border-radius: 20px; padding: 25px; box-sizing: border-box; position: relative; max-height: 85%; overflow-y: auto; }
        .modal-title { font-size: 20px; font-weight: bold; text-align: center; margin-bottom: 20px; }
        
        .modal-back-btn { 
            position: absolute; top: 20px; left: 20px; 
            width: 24px; height: 24px; cursor: pointer; 
            transition: transform 0.2s;
        }
        .modal-back-btn:hover { transform: scale(1.1); }

        .step-block { display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px dashed #DDD; }
        .step-block:last-of-type { border-bottom: none; margin-bottom: 0; }
        .step-label { font-size: 16px; font-weight: bold; color: #555; }
        
        .category-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 10px; 
        }
        .cat-item { 
            background-color: transparent; 
            border: none; 
            padding: 0; 
            cursor: pointer; 
            display: flex; flex-direction: column; align-items: center;
        }
        .cat-item span { display: none; } 
        .cat-img { width: 60px; height: 60px; object-fit: contain; transition: transform 0.2s; }
        .cat-item:hover .cat-img { transform: scale(1.1); }
        .cat-item.selected .cat-img { 
            transform: scale(1.15); 
            filter: drop-shadow(0 4px 6px rgba(255, 213, 79, 0.6)); 
        }

        .chip-container { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .chip { padding: 8px 15px; background-color: #FFE082; border-radius: 20px; font-size: 14px; cursor: pointer; border: 2px solid transparent; }
        .chip.selected { border-color: #FF6B6B; background-color: #FFD54F; font-weight: bold; }
        
        .money-options { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .money-chip { padding: 10px 20px; background-color: #EFEBE6; border-radius: 20px; cursor: pointer; border: 2px solid transparent; font-size: 14px; }
        .money-chip.selected { border-color: #FF6B6B; background-color: #FFD54F; font-weight: bold; }
        
        #custom-amount-wrapper { display: none; width: 100%; margin-top: 10px; }
        #custom-amount-wrapper.show { display: block; animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .input-box { width: 100%; padding: 15px; background-color: #EFEBE6; border: none; border-radius: 10px; font-size: 16px; text-align: center; font-weight: bold; box-sizing: border-box; }
        
        /* [ìˆ˜ì •ë¨] ê¸ˆì•¡ ì…ë ¥ì°½ ë°‘ì¤„ ìŠ¤íƒ€ì¼ (Homeê³¼ ë™ì¼) */
        .input-underline {
            width: 100%; padding: 10px 5px;
            background-color: transparent;
            border: none;
            border-bottom: 3px solid #333; /* êµµì€ ë°‘ì¤„ */
            font-size: 32px; /* í° ê¸€ì”¨ */
            text-align: center; font-weight: 800;
            margin-bottom: 20px; outline: none;
        }

        .date-picker-container { display: flex; gap: 10px; justify-content: center; align-items: center; margin-bottom: 10px; }
        .date-input { padding: 10px; border-radius: 10px; border: 1px solid #ddd; background: #EFEBE6; width: 130px;}
        .date-result { text-align: center; color: #FF6B6B; font-weight: bold; font-size: 18px; margin-bottom: 20px; }
        .confirm-btn { width: 100%; padding: 15px; background-color: #FFD54F; border: none; border-radius: 30px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; }

        .history-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 15px; }
        .history-card { padding: 20px; border-radius: 15px; border: 3px solid #DDD; background-color: #FFF; position: relative; }
        .history-card.ongoing { border-color: #FFD54F; background-color: #FFF9E6; }
        .history-card.fail { border-color: #FF6B6B; background-color: #FFF0F0; }
        .history-card.success { border-color: #4D96FF; background-color: #E1F5FE; }
        .h-tag { font-size: 12px; color: #666; margin-bottom: 5px; }
        .h-title { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        .h-date { font-size: 12px; color: #888; margin-bottom: 10px; }
        .h-status-badge { position: absolute; bottom: 20px; right: 20px; padding: 8px 15px; border-radius: 5px; font-weight: bold; font-size: 12px; }
        .ongoing .h-status-badge { background-color: #FFD54F; }
        .fail .h-status-badge { background-color: #FF6B6B; color: white; }
        .success .h-status-badge { background-color: #4D96FF; color: white; }
        .h-total-saved { margin-top: 10px; font-weight: bold; color: #4D96FF; font-size: 14px; }
    </style>
</head>
<body>

    <div class="header">ì±Œë¦°ì§€</div>

    <div class="content-container">
        <div class="section-title">ì§„í–‰ì¤‘ì¸ ì±Œë¦°ì§€</div>
        <div id="challenge-list-container"></div>
        <div id="add-challenge-box" class="add-challenge-box" onclick="openAddChallengeModal()"><span>+</span> ì±Œë¦°ì§€ ì¶”ê°€</div>
        <button class="history-btn" onclick="openHistoryModal()">ì§€ê¸ˆê¹Œì§€ í•œ ì±Œë¦°ì§€ ëª©ë¡</button>
    </div>

    <div class="navbar">
        <a href="home.html" class="nav-item">
            <div class="nav-icon-box"><img src="icon_home.png" class="nav-icon-img"></div>
            <span class="nav-text">í™ˆ</span>
        </a>
        <a href="stat.html" class="nav-item">
            <div class="nav-icon-box"><img src="icon_stat.png" class="nav-icon-img"></div>
            <span class="nav-text">í†µê³„</span>
        </a>
        <div class="nav-item active">
            <div class="nav-icon-box"><img src="icon_challenge.png" class="nav-icon-img"></div>
            <span class="nav-text">ì±Œë¦°ì§€</span>
        </div>
        <a href="user.html" class="nav-item">
            <div class="nav-icon-box"><img src="icon_user.png" class="nav-icon-img"></div>
            <span class="nav-text">ë‚˜ì˜ ì •ë³´</span>
        </a>
    </div>

    <div id="add-money-modal" class="modal-overlay">
        <div class="modal-content">
            <img src="back.png" class="modal-back-btn" onclick="closeModal('add-money-modal')" alt="ë’¤ë¡œê°€ê¸°">
            <div class="modal-title">ì ˆì•½ ê¸ˆì•¡ ì¶”ê°€í•˜ê¸°</div>
            
            <input type="number" id="money-input" class="input-underline" placeholder="0">
            
            <div style="text-align:center; color:#888; margin-bottom:20px; font-size:12px;">(í˜„ì¬ ëˆ„ì  ì ˆì•½ ê¸ˆì•¡: <span id="modal-current-saved">0</span>ì›)</div>
            <div class="money-options" style="justify-content:center; margin-bottom:20px;">
                <button class="chip" onclick="addInputMoney(100)">+100</button>
                <button class="chip" onclick="addInputMoney(500)">+500</button>
                <button class="chip" onclick="addInputMoney(1000)">+1,000</button>
                <button class="chip" onclick="addInputMoney(10000)">+1ë§Œ</button>
            </div>
            <button class="confirm-btn" onclick="confirmAddMoney()">ì™„ë£Œ</button>
        </div>
    </div>

    <div id="add-challenge-modal" class="modal-overlay">
        <div class="modal-content">
            <img src="back.png" class="modal-back-btn" onclick="closeModal('add-challenge-modal')" alt="ë’¤ë¡œê°€ê¸°">
            <div class="modal-title">ì±Œë¦°ì§€ ì¶”ê°€</div>
            
            <div class="step-block">
                <div class="step-label">Step 1. ì¹´í…Œê³ ë¦¬ ì„ íƒ</div>
                <div class="category-grid">
                    <div class="cat-item" onclick="selectCategory('meal', this)"><img src="cat_meal.png" class="cat-img"></div>
                    <div class="cat-item" onclick="selectCategory('transport', this)"><img src="cat_transport.png" class="cat-img"></div>
                    <div class="cat-item" onclick="selectCategory('shopping', this)"><img src="cat_shopping.png" class="cat-img"></div>
                    <div class="cat-item" onclick="selectCategory('leisure', this)"><img src="cat_leisure.png" class="cat-img"></div>
                </div>
            </div>
            <div class="step-block">
                <div class="step-label">Step 2. ì„¸ë¶€ ë‚´ìš© ì„ íƒ</div>
                <div id="chip-area" class="chip-container"><span style="color:#aaa; font-size:14px;">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</span></div>
            </div>
            <div class="step-block">
                <div class="step-label">Step 3. ì§€ì¶œ í•­ëª© ê¸ˆì•¡ ì„ íƒ</div>
                <div class="money-options">
                    <div class="money-chip" onclick="selectTargetAmount(0, this)">0ì›</div>
                    <div class="money-chip" onclick="selectTargetAmount(5000, this)">5,000ì›</div>
                    <div class="money-chip" onclick="selectTargetAmount(10000, this)">10,000ì›</div>
                    <div class="money-chip" onclick="selectTargetAmount(30000, this)">30,000ì›</div>
                    <div class="money-chip" onclick="showCustomInput(this)">ì§ì ‘ ì…ë ¥</div>
                </div>
                <div id="custom-amount-wrapper">
                    <input type="number" id="custom-target-amount" class="input-box" placeholder="ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
            </div>
            <div class="step-block">
                <div class="step-label">Step 4. ê¸°ê°„ ì„ íƒ</div>
                <div class="date-picker-container">
                    <input type="date" id="start-date" class="date-input" onchange="calcDuration()">
                    <span>~</span>
                    <input type="date" id="end-date" class="date-input" onchange="calcDuration()">
                </div>
                <div class="date-result" id="duration-result"></div>
            </div>
            <div class="step-block">
                <div class="step-label">Step 5. ì±Œë¦°ì§€ ì´ë¦„ ì„¤ì •</div>
                <input type="text" id="challenge-name-input" class="input-box" placeholder="ì˜ˆ: 3ì¼ê°„ ì»¤í”¼ ëŠê¸°">
            </div>
            <button class="confirm-btn" onclick="createChallenge()">ì±Œë¦°ì§€ ìƒì„± ì™„ë£Œ</button>
        </div>
    </div>

    <div id="history-modal" class="modal-overlay">
        <div class="modal-content">
            <img src="back.png" class="modal-back-btn" onclick="closeModal('history-modal')" alt="ë’¤ë¡œê°€ê¸°">
            <div class="modal-title">ì—­ëŒ€ ì±Œë¦°ì§€ ëª©ë¡</div>
            <ul id="history-list" class="history-list"></ul>
            <button id="history-more-btn" class="confirm-btn" style="background:#EEE; font-size:14px; margin-top:10px;" onclick="showMoreHistory()">â¬‡ ë” ë³´ê¸°</button>
        </div>
    </div>

    <script>
        let challenges = []; 
        let newChallenge = {};
        let selectedChallengeId = null;
        let currentUser = null;

        const subCategories = {
            'meal': ['ë°°ë‹¬ìŒì‹', 'í•™ì‹', 'í¸ì˜ì ', 'ë§ˆíŠ¸', 'ë ˆìŠ¤í† ë‘', 'ê¸¸ê±°ë¦¬', 'íšŒì‹'],
            'transport': ['ë²„ìŠ¤', 'ì§€í•˜ì² ', 'íƒì‹œ', 'ê¸°ì°¨', 'í‚¥ë³´ë“œ', 'ìê°€ìš©', 'ì¹´í’€'],
            'shopping': ['ë°±í™”ì ', 'ì˜ë¥˜ê°€ê²Œ', 'ê¸°ë…í’ˆ', 'í™”ì¥í’ˆ', 'ë‹¤ì´ì†Œ', 'ë¬¸êµ¬ì ', 'ì „ìì œí’ˆ'],
            'leisure': ['ë¯¸ìˆ ', 'ìŒì•…', 'ìŠ¤í¬ì¸ ', 'ë¬¸í•™', 'íœ´ì‹', 'ì—¬í–‰', 'ê²Œì„']
        };

        const catMap = {
            'meal': 'ì‹ì‚¬',
            'transport': 'êµí†µ',
            'shopping': 'ì‡¼í•‘',
            'leisure': 'ì—¬ê°€'
        };

        window.onload = function() {
            const savedUser = localStorage.getItem('loginUser');
            if(!savedUser) { alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); location.href='login.html'; return; }
            currentUser = JSON.parse(savedUser);
            loadServerData();
        };

        function loadServerData() {
            fetch(`/api/challenges/${currentUser.id}`)
            .then(res => res.json())
            .then(data => {
                challenges = data;
                checkChallengeStatus();
                renderMain();
            })
            .catch(err => {
                console.error("ì±Œë¦°ì§€ ë¡œë“œ ì‹¤íŒ¨:", err);
                challenges = [];
            });
        }

        function createChallenge() {
            const title = document.getElementById('challenge-name-input').value;
            if(!newChallenge.cat) { alert("ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš” (Step 1)"); return; }
            if(!newChallenge.sub) { alert("ì„¸ë¶€ ë‚´ìš©ì„ ì„ íƒí•´ì£¼ì„¸ìš” (Step 2)"); return; }
            
            if(newChallenge.isCustom) {
                const customVal = document.getElementById('custom-target-amount').value;
                if(!customVal) { alert("ì§ì ‘ ì…ë ¥í•  ê¸ˆì•¡ì„ ì ì–´ì£¼ì„¸ìš”"); return; }
                newChallenge.targetAmt = parseInt(customVal);
            }
            if(newChallenge.targetAmt === undefined || isNaN(newChallenge.targetAmt)) {
                alert("ì§€ì¶œ í•­ëª© ê¸ˆì•¡ì„ ì„ íƒí•˜ê±°ë‚˜ ì…ë ¥í•´ì£¼ì„¸ìš” (Step 3)"); return;
            }

            if(!newChallenge.startStr || !newChallenge.endStr) { alert("ê¸°ê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš” (Step 4)"); return; }
            if(!title) { alert("ì±Œë¦°ì§€ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (Step 5)"); return; }

            fetch('/api/challenge', {
                method: 'POST', 
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    userId: currentUser.id,
                    title: title,
                    category: newChallenge.cat,
                    subCategory: newChallenge.sub,
                    targetAmount: newChallenge.targetAmt,
                    startDate: newChallenge.startStr,
                    endDate: newChallenge.endStr
                })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    alert("ì±Œë¦°ì§€ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    loadServerData();
                    closeModal('add-challenge-modal');
                } else {
                    alert("ìƒì„± ì‹¤íŒ¨: ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            })
            .catch(err => {
                console.error(err);
                alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨! (ì„œë²„ê°€ ì¼œì ¸ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”)");
            });
        }

        function checkChallengeStatus() {
            const today = new Date(); today.setHours(0,0,0,0);
            challenges.forEach(c => {
                if(c.status === 'ongoing') {
                    const end = new Date(c.end_date);
                    if(today > end) {
                        updateChallengeStatus(c.id, c.saved_amount, 'success');
                        alert(`ğŸ‰ ì±Œë¦°ì§€ ì„±ê³µ! [${c.title}]`);
                    }
                }
            });
        }

        function updateChallengeStatus(id, savedAmount, status) {
            fetch('/api/challenge/update', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id, savedAmount, status })
            })
            .then(res => res.json())
            .then(data => { if(data.success) loadServerData(); });
        }

        function renderMain() {
            const listContainer = document.getElementById('challenge-list-container');
            listContainer.innerHTML = "";
            const ongoingList = challenges.filter(c => c.status === 'ongoing');

            if(ongoingList.length === 0) {
                listContainer.innerHTML = "<div style='text-align:center; color:#aaa; padding:20px;'>ì§„í–‰ ì¤‘ì¸ ì±Œë¦°ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
            }

            ongoingList.forEach(c => {
                const startStr = c.start_date.split('T')[0];
                const endStr = c.end_date.split('T')[0];
                const today = new Date(); today.setHours(0,0,0,0);
                const end = new Date(endStr);
                const diff = Math.ceil((end - today) / (1000 * 60 * 60 * 24));
                const dDayText = (diff < 0) ? "ì¢…ë£Œ" : `D-${diff}`;

                const start = new Date(startStr);
                const totalDays = Math.round((end - start) / (1000 * 60 * 60 * 24)) + 1;
                const passed = Math.round((today - start) / (1000 * 60 * 60 * 24)) + 1;
                
                let pct = Math.floor((passed/totalDays)*100);
                if(pct>100) pct=100; if(pct<0) pct=0;

                const currentDayDisplay = Math.min(Math.max(passed, 0), totalDays);
                const catKorean = catMap[c.category] || c.category;

                const html = `
                    <div class="challenge-card">
                        <div class="card-cat">[${catKorean}] - ${c.sub_category}</div>
                        <div class="card-title">${c.title}</div>
                        <div class="card-date"><span>${startStr} ~ ${endStr}</span> <span class="d-day-red">${dDayText}</span></div>
                        
                        <div class="progress-container">
                            <div class="progress-wrapper">
                                <div class="progress-bar" style="width:${pct}%"></div>
                            </div>
                            <div class="progress-text">${currentDayDisplay} / ${totalDays}ì¼</div>
                        </div>

                        <div class="card-btns">
                            <button class="card-btn btn-add-money" onclick="openAddMoneyModal(${c.id}, ${c.saved_amount})">
                                ğŸ’° ì¶”ê°€<br><span style="font-size:10px;">(ëˆ„ì  ${c.saved_amount.toLocaleString()})</span>
                            </button>
                            <button class="card-btn btn-give-up" onclick="giveUpChallenge(${c.id})">âŒ í¬ê¸°</button>
                        </div>
                    </div>`;
                listContainer.innerHTML += html;
            });
        }

        function openAddMoneyModal(id, currentSaved) {
            selectedChallengeId = id;
            document.getElementById('money-input').value = "";
            document.getElementById('modal-current-saved').innerText = currentSaved.toLocaleString();
            document.getElementById('add-money-modal').classList.add('open');
        }
        function addInputMoney(amt) {
            const el = document.getElementById('money-input');
            el.value = (parseInt(el.value)||0) + amt;
        }
        function confirmAddMoney() {
            const amt = parseInt(document.getElementById('money-input').value);
            if(!amt || amt <= 0) return;
            const target = challenges.find(c => c.id === selectedChallengeId);
            if(target) {
                updateChallengeStatus(target.id, target.saved_amount + amt, 'ongoing');
                closeModal('add-money-modal');
                alert("ê¸ˆì•¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");
            }
        }
        function giveUpChallenge(id) {
            if(!confirm("ì •ë§ í¬ê¸°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const target = challenges.find(c => c.id === id);
            if(target) {
                updateChallengeStatus(id, target.saved_amount, 'fail');
                alert("ì±Œë¦°ì§€ë¥¼ í¬ê¸°í–ˆìŠµë‹ˆë‹¤.");
            }
        }

        let historyLimit = 3;
        function openHistoryModal() { historyLimit = 3; renderHistory(); document.getElementById('history-modal').classList.add('open'); }
        function renderHistory() {
            const list = document.getElementById('history-list'); list.innerHTML = "";
            const viewList = challenges.slice(0, historyLimit);
            viewList.forEach(c => {
                const li = document.createElement('li');
                li.className = `history-card ${c.status}`;
                let statusText = (c.status==='fail')?"ì‹¤íŒ¨":(c.status==='success')?"ì„±ê³µ":"ì§„í–‰ ì¤‘";
                const startStr = c.start_date.split('T')[0];
                const endStr = c.end_date.split('T')[0];
                const catKorean = catMap[c.category] || c.category;

                li.innerHTML = `
                    <div class="h-tag">[${catKorean}] - ${c.sub_category}</div>
                    <div class="h-title">${c.title}</div>
                    <div class="h-date">(${startStr} ~ ${endStr})</div>
                    <div class="h-total-saved">ëª¨ì€ ê¸ˆì•¡: ${c.saved_amount.toLocaleString()}ì›</div>
                    <div class="h-status-badge">${statusText}</div>
                `;
                list.appendChild(li);
            });
            document.getElementById('history-more-btn').style.display = (challenges.length > historyLimit) ? 'block' : 'none';
        }
        function showMoreHistory() { historyLimit += 3; renderHistory(); }

        // --- UI Logic ---
        function openAddChallengeModal() {
            newChallenge = { saved: 0, isCustom: false };
            document.querySelectorAll('.cat-item').forEach(el=>el.classList.remove('selected'));
            document.getElementById('chip-area').innerHTML = '<span style="color:#aaa;">ì¹´í…Œê³ ë¦¬ ì„ íƒ í•„ìš”</span>';
            document.getElementById('custom-target-amount').value = "";
            document.getElementById('custom-amount-wrapper').classList.remove('show');
            document.querySelectorAll('.money-chip').forEach(c=>c.classList.remove('selected'));
            
            document.getElementById('challenge-name-input').value = "";
            const today = new Date(); const next = new Date(); next.setDate(today.getDate()+7);
            document.getElementById('start-date').valueAsDate = today;
            document.getElementById('end-date').valueAsDate = next;
            calcDuration();
            document.getElementById('add-challenge-modal').classList.add('open');
        }

        function selectCategory(cat, el) {
            newChallenge.cat = cat;
            document.querySelectorAll('.cat-item').forEach(e=>e.classList.remove('selected')); el.classList.add('selected');
            const area = document.getElementById('chip-area'); area.innerHTML = "";
            subCategories[cat].forEach(sub => {
                const chip = document.createElement('div'); chip.className = 'chip'; chip.innerText = sub;
                chip.onclick = () => { newChallenge.sub = sub; document.querySelectorAll('.chip').forEach(c=>c.classList.remove('selected')); chip.classList.add('selected'); };
                area.appendChild(chip);
            });
            const direct = document.createElement('div'); direct.className = 'chip'; direct.innerText = "ì§ì ‘ ì…ë ¥";
            direct.onclick = () => { const t = prompt("ì…ë ¥"); if(t){ newChallenge.sub=t; document.querySelectorAll('.chip').forEach(c=>c.classList.remove('selected')); direct.classList.add('selected'); }};
            area.appendChild(direct);
        }

        function selectTargetAmount(amt, el) {
            newChallenge.isCustom = false;
            newChallenge.targetAmt = parseInt(amt);
            document.querySelectorAll('.money-chip').forEach(c=>c.classList.remove('selected')); 
            if(el) el.classList.add('selected');
            document.getElementById('custom-amount-wrapper').classList.remove('show');
        }

        function showCustomInput(el) {
            newChallenge.isCustom = true;
            document.querySelectorAll('.money-chip').forEach(c=>c.classList.remove('selected')); 
            el.classList.add('selected');
            document.getElementById('custom-amount-wrapper').classList.add('show');
            document.getElementById('custom-target-amount').focus();
        }

        function calcDuration() {
            const s = new Date(document.getElementById('start-date').value);
            const e = new Date(document.getElementById('end-date').value);
            if(s && e && e >= s) {
                const diff = (e - s)/(1000*60*60*24)+1;
                document.getElementById('duration-result').innerText = `${Math.ceil(diff)}ì¼ê°„`;
                newChallenge.startStr = document.getElementById('start-date').value;
                newChallenge.endStr = document.getElementById('end-date').value;
            } else document.getElementById('duration-result').innerText = "ë‚ ì§œ í™•ì¸";
        }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
    </script>
</body>
</html>